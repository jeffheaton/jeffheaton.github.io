'use strict';function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}var MergeLifeRender=function(){var a=Math.max,b=Math.floor;this.parseUpdateRule=function(a){var b=a.indexOf(';');-1!==b&&(a=a.substring(0,b)),a=a.replace(/\W+/g,'');for(var c=[],d=0;8>d;d++){var e=4*d,f=a.substr(e,2),g=a.substr(e+2,2),h=parseInt(f,16),i=parseInt(g,16);0<(128&i)&&(i-=256);var j=0<i?i/127:i/128,k=8*h;2040<=k&&(k=2048),c.push([k,j,d,f,g,h,i])}return c.sort(function(c,a){return c[0]-a[0]}),c},this.randomGrid=function(a){for(var c,d=a||this.grid[this.currentGrid],e=0;e<d.length;e+=1){c=d[e];for(var f,g=0;g<c.length;g+=1){f=c[g];for(var h=0;3>h;h++)f[h]=b(256*Math.random())}}},this.calculateModeGrid=function(c,d){for(var e=Array.apply(null,Array(256)).map(Number.prototype.valueOf,0),f=0;f<c.length;f+=1)for(var g=c[f],h=d[f],j=0;j<g.length;j+=1){for(var k=g[j],l=0,m=0;3>m;m++)l+=k[m];var n=b(l/3);e[n]+=1,h[j]=n}return e.indexOf(a.apply(Math,_toConsumableArray(e)))},this.sumNeighbor=function(a,b,c,d){for(var e=[0,0,-1,1,-1,1,1,-1],f=[-1,1,0,0,-1,1,-1,1],g=0,h=0;h<e.length;h++){var j=f[h]+b,k=e[h]+c;g+=0<=j&&0<=k&&j<a.length&&k<a[0].length?a[j][k]:d}return g},this.updateStep=function(a,c,e){this.gridMode=this.calculateModeGrid(a,this.mergeGrid);for(var n=0;n<a.length;n+=1)for(var f,g=a[n],h=c[n],k=0;k<g.length;k+=1){f=this.sumNeighbor(this.mergeGrid,n,k,this.gridMode);for(var o=0;o<e.length;o++)if(f<e[o][0]){var l=e[o][2],m=e[o][1];0>m&&(m=Math.abs(m),l+=1,l>=e.length&&(l=0));for(var i,d=0;3>d;d++)i=MergeLifeRender.prototype.KEY_COLOR[l][d]-a[n][k][d],i*=m,i=b(i),h[k][d]=g[k][d]+i;break}}},this.getColor=function(a){return[a[0],a[1],a[2]]},this.ccomp=function(c,d,e){var f=a(c,d),g=Math.min(c,d);return b((f-g)*(e/255)+g)},this.getColorRange=function(a){var c=this.ccomp(this.colorRangeLow[0],this.colorRangeHigh[0],a[0]),d=this.ccomp(this.colorRangeLow[1],this.colorRangeHigh[1],a[1]),e=this.ccomp(this.colorRangeLow[2],this.colorRangeHigh[2],a[2]);return[c,d,e]},this.singleStep=function(){this.stepCount+=1,this.updateStep(this.grid[this.currentGrid],this.grid[0===this.currentGrid?1:0],this.updateRule),this.currentGrid=0===this.currentGrid?1:0},this.animateFunction=function(){this.autoStep&&this.singleStep(),this.render(0,this.grid[this.currentGrid])},this.stopAnimation=function(){clearInterval(this.updateEvent),this.updateEvent=null},this.startAnimation=function(a){var b=this;this.stepCount=0,this.randomGrid(this.grid[this.currentGrid]),null===this.updateEvent&&(this.updateEvent=setInterval(function(){return b.animateFunction()},a||10))},this.render=function(){var a=this.grid[this.currentGrid];this.ctx.strokeStyle='grey';for(var b=this.ctx.canvas.clientWidth,c=this.ctx.canvas.clientHeight,d=a[0].length,e=a.length,f=this.imgdata.data,g=4*b,h=0;h<e;h+=1)for(var i,j=0;j<this.cellSize;j++){i=g*this.cellSize*h+g*j;for(var k,l=0;l<d;l+=1){k=null==this.colorRangeLow?this.getColor(a[h][l]):this.getColorRange(a[h][l]);for(var m=0;m<this.cellSize;m++)f[i]=k[0],f[i+1]=k[1],f[i+2]=k[2],f[i+3]=255,i+=4}}this.ctx.putImageData(this.imgdata,0,0),this.mouseInside&&this.controlsOn&&this.renderControls(),this.postRenderFunction&&this.postRenderFunction(this.ctx)},this.renderButton=function(a){var b=5+35*a,c=this.ctx.canvas.height-40;return this.ctx.globalAlpha=.8,this.ctx.fillStyle='#a0a0a0',this.ctx.fillRect(b,c,32,32),this.ctx.lineWidth=2,this.ctx.fillStyle='#606060',this.ctx.strokeStyle='#606060',this.ctx.strokeRect(b,c,32,32),this.ctx.globalAlpha=1,[b,c]},this.renderStopButton=function(a){var b=this.renderButton(a),c=b[0],d=b[1];this.ctx.fillRect(c+8,d+8,16,16)},this.renderPauseButton=function(a){var b=this.renderButton(a),c=b[0],d=b[1];this.ctx.fillRect(c+8,d+8,6,16),this.ctx.fillRect(c+18,d+8,6,16)},this.renderPlayButton=function(a){var b=this.renderButton(a),c=b[0],d=b[1];this.ctx.beginPath(),this.ctx.moveTo(c+10,d+8),this.ctx.lineTo(c+10,d+24),this.ctx.lineTo(c+22,d+15),this.ctx.closePath(),this.ctx.fill()},this.renderClearButton=function(a){var b=this.renderButton(a),c=b[0],d=b[1];this.ctx.strokeStyle='black',this.ctx.beginPath(),this.ctx.moveTo(c+8,d+8),this.ctx.lineTo(c+24,d+24),this.ctx.closePath(),this.ctx.stroke()},this.renderStepButton=function(a){var b=this.renderButton(a),c=b[0],d=b[1];this.ctx.beginPath(),this.ctx.moveTo(c+10,d+8),this.ctx.lineTo(c+10,d+24),this.ctx.lineTo(c+22,d+15),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillRect(c+20,d+8,4,16)},this.renderControls=function(){this.ctx.font='bold 20px Georgia';var a=this.stepCount.toLocaleString(),b=this.ctx.measureText('M').width,c=b,d=this.ctx.canvas.width-(this.ctx.measureText(a).width+10);this.ctx.fillStyle='#ffffff',this.ctx.strokeStyle='black',this.ctx.lineWidth=7,this.ctx.strokeText(a,d,c),this.ctx.fillText(a,d,c),this.autoStep?this.renderPauseButton(0):this.renderPlayButton(0),this.renderStepButton(1),this.renderStopButton(2)},this.mouseEnter=function(){this.mouseInside=!0},this.mouseExit=function(){this.mouseInside=!1},this.mouseUp=function(a){var c=a.layerX,d=a.layerY,e=this.ctx.canvas.height-40;if(d>=e&&d<e+32&&this.controlsOn){var f=b((c-5)/35);0===f?this.autoStep=!this.autoStep:1===f?this.singleStep():2===f?(this.randomGrid(this.grid[this.currentGrid]),this.autoStep=!1):void 0}},this.init=function(a){var b=this;this.rows=0,this.cols=0,this.gridMode=0,null==a.canvas?(this.rows=a.rows||100,this.cols=a.cols||100,this.autoStep=!1,this.controlsOn=!1):(this.ctx=a.canvas.getContext('2d'),this.cellSize=a.cellSize||5,this.rows=this.ctx.canvas.height/this.cellSize,this.cols=this.ctx.canvas.width/this.cellSize,this.ctx.canvas.addEventListener('mouseenter',function(){return b.mouseEnter()}),this.ctx.canvas.addEventListener('mouseout',function(){return b.mouseExit()}),this.ctx.canvas.addEventListener('mouseup',function(a){return b.mouseUp(a)}),this.autoStep=!0,this.controlsOn=!0===a.controls,this.imgdata=this.ctx.getImageData(0,0,this.ctx.canvas.width,this.ctx.canvas.height)),this.grid=[],this.grid[0]=MergeLifeRender.zeros([this.rows,this.cols,3]),this.grid[1]=MergeLifeRender.zeros([this.rows,this.cols,3]),this.mergeGrid=MergeLifeRender.zeros([this.rows,this.cols,1]),this.currentGrid=0,this.updateRule=null,this.updateEvent=null,this.stepCount=0,this.randomGrid(this.grid[0]);var c=this.parseUpdateRule(a.rule);this.updateRule=c},this.postRenderFunction=null,this.colorRangeLow=null,this.colorRangeHigh=null,this.mouseInside=!1};MergeLifeRender.prototype.KEY_COLOR=[[0,0,0],[255,0,0],[0,255,0],[255,255,0],[0,0,255],[255,0,255],[0,255,255],[255,255,255]],MergeLifeRender.randomRule=function(){for(var a,b='',c=0;8>c;c++){for(a=Math.floor(65536*Math.random()).toString(16);4>a.length;)a='0'+a;0<b.length&&(b+='-'),b+=a}return b},MergeLifeRender.zeros=function(a){for(var b=[],c=0;c<a[0];++c)b.push(1===a.length?0:MergeLifeRender.zeros(a.slice(1)));return b},'undefined'!=typeof module&&'undefined'!=typeof module.exports&&(exports.MergeLifeRender=MergeLifeRender);